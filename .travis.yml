language: python

branches:
  except:
    - gh-pages

osx_image: xcode8.2
dist: trusty
sudo: required

matrix:
  exclude:
    - os: linux
    - os: osx

  include:
  - os: linux
    python: 2.7
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py27
  - os: linux
    python: 3.4
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py34
  - os: linux
    python: 3.5
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py35
  - os: linux
    python: 3.6
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py36
  - os: osx
    python: 2.7
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py27
  - os: osx
    python: 3.4
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py34
  - os: osx
    python: 3.5
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py35
  - os: osx
    python: 3.6
    env: BUILD_TYPE=Debug OSSIA_STATIC=1 TOXENV=py36

before_install:
- source ./scripts/split_repo_slug.sh

install: ./scripts/deps.sh

script:
  - ./scripts/build.sh
  - cd tests
  # codacy
  - coverage run --omit ../pyossia/_version.py --omit ../versioneer.py  --include=../pyossia/"*" test_.py
  - coverage xml
  - coverage report -m
  - python-codacy-coverage -r coverage.xml
  # build the documentation
  - cd ../
  - travis-sphinx build docs/source/source

after_success: 
  - travis-sphinx deploy
  - cd tests
  - coveralls

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: $SECURE_KEY
  file: ./dist/${REPO}-${TRAVIS_TAG}_${TOXENV}_${TRAVIS_OS_NAME}.tar.gz
  on:
    tags: true
    all_branches: true
    repo: PixelStereo/pyossia

deploy:
  provider: pypi
  user: $PyPiUser
  password: $PyPiPsswd
  on:
    tags: true
    all_branches: true
    repo: PixelStereo/pyossia
    condition: $TOXEN = py27
    condition: $TRAVIS_OS_NAME = linux

